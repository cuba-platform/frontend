= CUBA Platform Frontend Generator
// :imagesdir: attribute is ignored by Antora, which allows us to have images displayed properly both in README and generated site
:imagesdir: docs-src/doc-component-repo/modules/ROOT/images
:EntityEditorProps: link:api-reference/cuba-react-ui/interfaces/_ui_entityeditor_.entityeditorprops.html[EntityEditorProps]
:NestedEntityFieldProps: link:api-reference/cuba-react-ui/interfaces/_ui_form_nestedentityfield_.nestedentityfieldprops.html[NestedEntityFieldProps]
:NestedEntitiesTableField: link:api-reference/cuba-react-ui/interfaces/_ui_form_nestedentitiestablefield_.nestedentitiestablefieldprops.html[NestedEntitiesTableField]
:FileUploadProps: link:api-reference/cuba-react-ui/interfaces/_ui_fileupload_.fileuploadprops.html[FileUploadProps]
:ImagePreviewProps: link:api-reference/cuba-react-ui/interfaces/_ui_imagepreview_.imagepreviewprops.html[ImagePreviewProps]
:toc:
--------------------------------

https://travis-ci.org/cuba-platform/frontend[image:https://travis-ci.org/cuba-platform/frontend.svg?branch=master[Build
Status]]
http://commitizen.github.io/cz-cli/[image:https://img.shields.io/badge/commitizen-friendly-brightgreen.svg[Commitizen
friendly]]

[[overview]]
== Overview

This tool can be used to generate a front-end client for a CUBA
Platform based application. The client can be powered by one of the
following frameworks:

- React
- React Native
- Polymer (deprecated)
- a framework-agnostic link:#typescript-sdk[TypeScript SDK]

The front-end client is an alternative to the
https://doc.cuba-platform.com/manual-latest/gui_framework.html[Generic
UI] providing front-end oriented development experience. It's more
flexible in terms of layout customization and allows easy integration of
UI libraries and components from vast JavaScript ecosystem. However, it
requires better knowledge of modern front-end stack.

The generator is used by https://doc.cuba-platform.com/studio/[CUBA
Studio] for
https://doc.cuba-platform.com/manual-latest/front_ui.html[front module]
creation. Alternatively it can be used as a standalone CLI tool.

[[supported-browsers]]
=== Supported Browsers

The client supports all modern (evergreen) browsers. In order to support
IE 9,10,11
https://facebook.github.io/create-react-app/docs/supported-browsers-features[additional
configuration] required.

[[getting-started]]
== Getting Started

We recommend using an IDE with
http://www.typescriptlang.org/[TypeScript] support:
https://code.visualstudio.com/[VSCode],
https://www.jetbrains.com/webstorm/[WebStorm] or
https://www.jetbrains.com/idea/[IntelliJ IDEA] Ultimate Edition.

Steps will vary depending on whether you are using the generator from
CUBA Studio or as a standalone CLI tool.

[[getting-started-using-cuba-studio]]
=== Getting Started Using CUBA Studio

[[installation]]
*Installation*

Install https://doc.cuba-platform.com/studio/#installation[CUBA Studio].

[[generating-a-client-from-studio]]
*Generating a Client from Studio*

You can generate a client as
https://doc.cuba-platform.com/studio/#modules[a module of CUBA
application]. You will be able to create CRUD screens using CUBA Studio
UI.

[[getting-started-using-cli]]
=== Getting Started Using CLI

[[installation-1]]
*Installation*

Install https://nodejs.org/en/download/[Node.js] 12+ and npm 6+ (usually
comes with node).

Install the generator using npm package manager:

[source,bash]
----
npm install -g @cuba-platform/front-generator
----

Use the generator by running the following command in command line:

[source,bash]
----
gen-cuba-front
----

Alternatively, you can run the generator without installation using
https://www.npmjs.com/package/npx[npx]:

[source,bash]
----
npx @cuba-platform/front-generator
----

[[generating-a-client-using-cli]]
*Generating a Client Using CLI*

In order to generate a starter app, we need to feed the generator with
project metadata (what entities do we have, etc.). There are two ways of
doing that.

[[passing-project-metadata-from-cuba-studio]]
_Passing Project Metadata from CUBA Studio_

* Open your project in CUBA Studio.
* Open settings (`File > Settings`), then open
`Languages & Frameworks > CUBA`.
* Tick the `Old Studio integration` checkbox:

image:studio-integration.png[Enabling
Studio integration]

Now generator will be able to automatically detect CUBA projects opened
in Studio.

Generate a starter React app by running the following command:

[source,bash]
----
gen-cuba-front react-typescript:app
----

Generator will prompt you to select one of the currently opened CUBA
projects.

image:interactive-projects.png[Interactive
project selection]

[[passing-project-metadata-manually]]
_Passing Project Metadata Manually_

You can export the project model manually. Select
`CUBA > Advanced > Export project model` in the main menu. Studio will
generate `projectModel.json` file.

Use `--model` command line option to specify location of the project
model file:

[source,bash]
----
gen-cuba-front react-typescript:app --model /work/cuba-samples/sample-sales/projectModel.json
----

[[generator-cli]]
== Generator CLI

Run `gen-cuba-front` (or `npx @cuba-platform/front-generator`) without
arguments to see usage info.

....
Usage: gen-cuba-front [command] [options]

  Options:

    -v, --version  output the version number
    -h, --help     output usage information

  Commands:

    list [options]                                   List all available clients and their clients
    polymer2:app [options]                           Generates polymer2 app
    polymer2:blank-component [options]               Generates polymer2 blank-component
    polymer2:entity-cards [options]                  Generates polymer2 entity-cards
    polymer2:entity-edit [options]                   Generates polymer2 entity-edit
    polymer2:entity-list [options]                   Generates polymer2 entity-list
    polymer2:entity-management [options]             Generates polymer2 entity-management
    polymer2:query-results [options]                 Generates polymer2 query-results
    polymer2:service-data [options]                  Generates polymer2 service-data
    polymer2:service-form [options]                  Generates polymer2 service-form
    polymer2-typescript:app [options]                Generates polymer2-typescript app
    polymer2-typescript:blank-component [options]    Generates polymer2-typescript blank-component
    polymer2-typescript:entity-cards [options]       Generates polymer2-typescript entity-cards
    polymer2-typescript:entity-edit [options]        Generates polymer2-typescript entity-edit
    polymer2-typescript:entity-list [options]        Generates polymer2-typescript entity-list
    polymer2-typescript:entity-management [options]  Generates polymer2-typescript entity-management
    react-typescript:app [options]                   Generates react-typescript app
    react-typescript:blank-component [options]       Generates react-typescript blank-component
    react-typescript:entity-cards [options]          Generates react-typescript entity-cards
    react-typescript:entity-management [options]     Generates react-typescript entity-management
    sdk:all [options]                                Generates sdk all
    sdk:model [options]                              Generates sdk model
....

__________________________________
NOTE: Polymer client is deprecated
__________________________________

Run `gen-cuba-front <command> --help` to see the list of available
options.

Most commands use interactive prompts to capture necessary inputs such
as which entity you want to use, which
https://doc.cuba-platform.com/manual-latest/views.html[view], etc.
Alternatively, `answers` command line parameter can be used to provide
these inputs. You may want to use it if you want to automate the
generation. `answers` is a base64-encoded JSON string. See
link:#commands-description[descriptions of individual
commands] for details on what shall be put inside this JSON.

Example of using `answers`:

....
gen-cuba-front react-typescript:entity-management \
  --dest ../model-playground/modules/front/src/app/car \
  --model /home/myusername/model-playground/projectModel.json \
  --dirShift ../../ \
  --answers eyJlZGl0VmlldyI6eyJuYW1lIjoiY2FyLXZpZXciLCJlbnRpdHlOYW1lIjoibXBnJENhciJ9LCJlZGl0Q29tcG9uZW50TmFtZSI6Im1wZy1jYXItZWRpdCIsImxpc3RWaWV3Ijp7Im5hbWUiOiJjYXItdmlldyIsImVudGl0eU5hbWUiOiJtcGckQ2FyIn0sImxpc3RDb21wb25lbnROYW1lIjoibXBnLWNhci1saXN0IiwibGlzdFR5cGUiOiJsaXN0IiwiZW50aXR5Ijp7Im5hbWUiOiJtcGckQ2FyIn0sIm1hbmFnZW1lbnRDb21wb25lbnROYW1lIjoibXBnLWNhci1tYW5hZ2VtZW50In0=
....

[[commands-description]]
=== Commands Description

[[react-typescriptapp]]
*react-typescript:app*

Generates a React starter app. See link:#getting-started[Getting
started].

....
  Options:

    -d, --dest [dest]    destination directory
    -m, --model [model]  specify path to project model, if given no interactive prompt will be invoked
    -h, --help           output usage information
....

[[react-typescriptentity-management]]
*react-typescript:entity-management*

Generates:

- Route / main menu item
- Editor screen to create or edit an
entity
- Browser screen to view the list of entities and/or perform CRUD
operations.

....
  Options:

    -d, --dest [dest]           destination directory
    -m, --model [model]         specify path to project model, if given no interactive prompt will be invoked
    -ds, --dirShift [dirShift]  directory shift for html imports e.g ../../
    -a, --answers [answers]     fulfilled params for generator to avoid interactive input in serialized JSON string
    -h, --help                  output usage information
....

Browser screen is available in one of the following flavors (we call it
list types):

* list

image:react/browser-list.png[List browser
example]

* cards

image:react/browser-cards.png[Cards browser
example]

* table

image:react/data-table-demo.gif[Data table
showcase]

`answers` format:

....
{
    "editView": {
      "name": "car-edit", // Name of view that will be used in Editor screen
      "entityName": "mpg$Car" // Entity name
    },
    "editComponentName": "CarEdit", // Editor component class name 
    "listView": {
      "name": "car-edit", // Name of view that will be used in Browser screen
      "entityName": "mpg$Car" // Entity name
    },
    "listComponentName": "CarCards", // Browser component class name
    "listType": "cards", // List type: list, cards or table
    "entity": {
      "name": "mpg$Car" // Entity name
    },
    "managementComponentName": "CarManagement" // Management component class name (renders either Editor or Browser depending on current route) 
    }
}
....

[[react-typescriptentity-cards]]
*react-typescript:entity-cards*

Generates a list of entities where each entity is represented by a card
(similar to a Browser component with `"listType": "cards"`, see
link:#react-typescriptentity-management[react-typescript:entity-management])

....
  Options:

    -d, --dest [dest]           destination directory
    -m, --model [model]         specify path to project model, if given no interactive prompt will be invoked
    -ds, --dirShift [dirShift]  directory shift for html imports e.g ../../
    -a, --answers [answers]     fulfilled params for generator to avoid interactive input in serialized JSON string
    -h, --help                  output usage information
....

`answers` format:

....
{
    "entityView": {
      "name": "favoriteCar-view", // View name
      "entityName": "mpg$FavoriteCar" // Entity name 
    },
    "componentName": "FavoriteCarCards", // Component class name
    "entity": {
      "name": "mpg$FavoriteCar" // Entity name 
    }
}
....

[[react-typescriptblank-component]]
*react-typescript:blank-component*

Generates a blank component.

....
  Options:

    -d, --dest [dest]           destination directory
    -m, --model [model]         specify path to project model, if given no interactive prompt will be invoked
    -ds, --dirShift [dirShift]  directory shift for html imports e.g ../../
    -a, --answers [answers]     fulfilled params for generator to avoid interactive input in serialized JSON string
    -h, --help                  output usage information
....

`answers` format:

....
{
    "componentName": "BlankComponent" // Component class name
}
....

[[sdkall]]
*sdk:all*

Generates framework-agnostic link:#typescript-sdk[TypeScript SDK]. It is
also generated when executing `react-typescript:app` command.

....
  Options:

    -d, --dest [dest]    destination directory
    -m, --model [model]  specify path to project model, if given no interactive prompt will be invoked
    -h, --help           output usage information
....

[[sdkmodel]]
*sdk:model*

Generates SDK model only.

....
  Options:

    -d, --dest [dest]    destination directory
    -m, --model [model]  specify path to project model, if given no interactive prompt will be invoked
    -h, --help           output usage information
....

[[react-client]]
== React Client

[[overview-of-react-client]]
=== Overview of React Client

[[running-the-client]]
*Running the Client*

You can run the client by executing the following command:

[source,bash]
----
npm run start
----

This will launch a dev server and allow you to access your app at
`localhost:3000`.

If the client was generated via CUBA Studio (as a module of CUBA
application) you can use Gradle in order to run npm tooling:

[source,bash]
----
./gradlew npm_run_start
----

________________________________________________________________________________________________________________________________________________________________
NOTE: There is a known
https://github.com/srs/gradle-node-plugin/issues/339[bug] in Gradle node
plugin which does not kill JS development server on task interruption.
________________________________________________________________________________________________________________________________________________________________

You can also run your CUBA application normally (e.g. via
`CUBA -> Start Application Server`) and front-end client will be
accessible at `localhost:8080/app-front` (context root can be
link:#react-client-configuration[configured]). However, in this case hot
deploy will not be available. We recommend using one of the above
methods during development.

[[technologies]]
*Technologies*

The client is based on the following frameworks and libraries:

* https://reactjs.org/[React] - UI rendering;
* https://mobx.js.org/[MobX] - reactive state management;
* https://ant.design/docs/react/introduce[Ant Design] - UI components;
* https://reacttraining.com/react-router/[React Router] - routing;
* link:#cuba-react-core[CUBA React Core] - CUBA React core components and utilities;
* link:#cuba-react-ui[CUBA React UI] - CUBA React UI components
and utilities;
* link:api-reference/cuba-rest-js/index.html[CUBA REST JS^] - interaction with СUBA
generic REST API;
* https://facebook.github.io/create-react-app/[Create React App] - build
scripts and configuration;

[[project-structure]]
*Project Structure*

Here is the structure of the newly generated project:

....
app-name/
  package.json
  package-lock.json
  node_modules/
  public/
    index.html
    favicon.ico
  src/
    index.css
    index.tsx          <- App entry point. Do not move/rename this file
    routing.ts         <- Routing configuration
    app/
      App.css
      App.tsx          <- App shell. Switches between Login form and internal application
    cuba/              <- CUBA Model. See [Backend model]
      entitites/       <- Project entities
        base/          <- Entities from addons and framework
      enums/           <- Project enums
....

If the client was generated using Studio it's placed in `modules/front`
directory of main project.

[[creating-react-components]]
=== Creating React Components

It is highly recommended to read full
https://reactjs.org/docs/getting-started.html[React documentation]. In
React, like in many modern frameworks everything is a component. We use
components to create reusable blocks of our application as well as
particular pages and screens.

Let's create our first component: place file `Button.tsx` in `src`
directory:

[source,typescript]
----
import React, { Component } from 'react';

export class Button extends Component {
  render() {
    <button>Click me</button>;
  }
}
----

Alternatively, you can create the component using a function:

[source,typescript]
----
export function Button(props) {
  return <button>{props.name}</button>;
}
----

There are some useful components provided in link:#cuba-react-core[CUBA React Core] and link:#cuba-react-ui[CUBA React UI] libraries. Please see the corresponding sections for more details.

[[observable-state-with-mobx]]
=== Observable State with MobX

https://mobx.js.org/intro/overview.html[MobX] is a library for reactive
state management which enables to work with state in a convenient and
concise way.

Consider the following example:

[source,typescript]
----
@observer
class Counter extends React.Component {

  @observable
  count = 0;

  render() {
    return (
      <div>
        Counter: {this.count} <br />
        <button onClick={this.handleInc}> + </button>
        <button onClick={this.handleDec}> - </button>
      </div>
    )
  }

  handleInc = () => {
    this.count++;
  }

  handleDec = () => {
    this.count--;
  }
}
----

As soon as we decorate a class or a function component as
https://mobx.js.org/refguide/observer-component.html[observer], it
automatically subscribes to changes on any
https://mobx.js.org/refguide/observable.html[observable] value or object
i.e. in the example above changing `count` property will result in
automatic re-render of the component.

[[routing-and-menu]]
=== Routing and Menu

Routing is based on well-known
https://reacttraining.com/react-router/web/guides/quick-start[React
Router] library. The generated app has a single point (`src/routing.ts`)
to define screens which will be automatically placed in the main menu:

[source,typescript]
----
menuItems.push({
  pathPattern: '/pets', // pattern may be used to consume some parameters, e.g.: /pets/:petId?
  menuLink: '/pest',
  component: PetBrowser, // component to be rendered, should be imported in `routes.ts`
  caption: 'Pets' // Menu item caption
});
----

The `src/App.tsx` contains `Switch` component which renders screen
depending on the URL path:

[source,typescript]
----
  <Switch>
    <Route exact={true} path="/" component={HomePage}/>
  {collectRouteItems(menuItems).map(route => (  // get all routes from main and sub menus
  <Route key={route.pathPattern} path={route.pathPattern} component={route.component}/>
    )}
  </Switch>
----

You can manually add `Route` to `Switch` component or customize the
structure used in `routes.ts` for example in order to create
hierarchical menu.

[[sub-menus]]
*Sub Menus*

To create hierarchical menu you need to create `SubMenu` instance in
`routes.ts` and add it to `menuItems`

[source,typescript]
----
// This is RouteItem object that we want to see in User Settings sub menu
const userProfileRouteItem = {
  pathPattern: "/profile",
  menuLink: "/profile",
  component: UserProfile,
  caption: "UserProfile"
};

// SubMenu
const userSettingsSubMenu = {
  caption: 'UserSettings', // add router.UserSettings key to src/i18n/en.json for valid caption
  items: [userProfileRouteItem]};

// Add sub menu to menu config
menuItems.push(userSettingsSubMenu);
----

Sub menus can have unlimited nesting. One sub menu could be used as item
of another.

[[forms]]
=== Forms

In order to facilitate data binding, Ant Design's
https://ant.design/components/form/[Form] component and utilities are
used in the app. On top of that we provide a `Field` component which
automatically renders corresponding component basing on metadata. See
the following example:

[source,typescript]
----
  <Field
    entityName={Car.NAME}
    propertyName="manufacturer"
    form={this.props.form}
    formItemOpts={{ style: { marginBottom: "12px" } }}
    getFieldDecoratorOpts={{
      rules: [{ required: true }]
    }}
    componentProps= {{
      maxLength: 4
    }}
  />
----

You can customize underlying components, validation rules and binding
using `getFieldDecoratorOpts` and `componentProps` properties.

[[i18n]]
=== I18n

i18n is powered by https://github.com/formatjs/react-intl[react-intl]
library.

Out of the box React client supports `en` and `ru` locales.

[[adding-new-localized-content]]
*Adding New Localized Content*

* Add new messages to `src/i18n/\{locale}.json` files
* Refer to them from your code using standard `react-intl` components or
API (see
https://github.com/formatjs/react-intl/blob/master/docs/README.md[documentation])

[[overriding-existing-messages]]
*Overriding Existing Messages*

Simply replace existing messages in `src/i18n/\{locale}.json` files. This
way you can override messages in client app,
link:#cuba-react-ui[CUBA React UI] components and some of the
messages in `antd` components.

[[adding-support-for-new-locales]]
*Adding Support for New Locales*

* Add a corresponding `\{locale}.json` message pack. Note that it shall
contain messages for link:#cuba-react-ui[CUBA React UI]
components (keys starting with `cuba-react`) and `antd` `Form`
validation messages (keys starting with `antd.form.validation`)
* Create a mapping between locale and message pack by modifying
`messagesMapping` in `src/i18n/i18nMappings.ts`
* Create a mapping between locale and `antd/es/locale-provider/Locale`
object by modifying `antdLocaleMapping` in `src/i18n/i18nMappings.ts`.
This is required because most of the messages in `antd` components are
translated by telling `antd` to use one of the predefined locales. An
extensive list of locales supported by `antd` can be found
https://ant.design/docs/react/i18n[here].
* Add import of corresponding https://github.com/moment/moment[moment]
locale to `index.tsx`, e.g. `import 'moment/locale/ru';` > This is
required because some of `antd` components use localized messages from
`moment`.
* Add a means of switching to the new locale. E.g. if you are using the
default `LanguageSwitcher` - add a locale option into it.

[[customizing-theme]]
=== Customizing Theme

Ant Design provides a possibility to
https://ant.design/docs/react/customize-theme[customize theme] using
`less` and overriding built-in variables. You can also use these
variables in your own code.

In order to do so, you will need to make some modifications to the
generated app.

__________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________
NOTE: You will have to enable deprecated inline Javascript in `less` as
`antd` makes heavy use of it.
http://lesscss.org/usage/#less-options-strict-units[Reasons for
deprecation.]
__________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________

- Install the required dependencies. Note that we are
using https://github.com/timarney/react-app-rewired[react-app-rewired]
to modify the webpack config without having to `eject`. +

[source,bash]
----
npm i react-app-rewired less less-loader customize-cra babel-plugin-import --save-dev
----

- Create `config-overrides.js` file in the app root. The file shall look
like this.

[source,typescript]
----
const {addLessLoader, override, fixBabelImports} = require("customize-cra");
const path = require('path');
module.exports = override(
  fixBabelImports('import', {
      libraryName: 'antd',
      libraryDirectory: 'es',
      style: true,
  }),
  addLessLoader({
    javascriptEnabled: true,
    modifyVars: {
      'overrideTheme': `true; @import "${path.resolve(__dirname, './src/theme.less')}";`,
    },
  }),
);
----

Now you can place your overrides in `src/theme.less`:

[source,less]
----
@primary-color: #1DA57A;
----

You can use `antd` variables in your code like this:

[source,less]
----
@import "~antd/es/style/themes/default";
body {
  background: @list-header-background;
}
----

References:

- detailed
https://ant.design/docs/react/use-with-create-react-app#Customize-Theme[documentation]
on Ant Design website

[[css-methodology]]
*CSS Methodology*

Both the generated client and link:#cuba-react-ui[CUBA React UI] follow
http://rscss.io[RSCSS methodology]. Additionally, we adopt Base Rules
from http://smacss.com/book/type-base[SMACSS methodology].

[[backend-model]]
=== Backend Model

`src/cuba` directory contains TypeScript representation of project's
entities, views and facades to access REST services. See more details in
link:#typescript-sdk[TypeScript SDK] section. Here is the layout of the
directory:

* `entities` - project entities and views;
* `entities/base` - framework and addons entities;
* `enums` - project enums;
* `services.ts` - middleware services exposed to REST;
* `queries.ts` - REST queries.

Consider the `Role` entity class of CUBA Framework generated in
typescript:

`src/cuba/entities/base/sec$Role.ts`

[source,typescript]
----
export class Role extends StandardEntity {
    static NAME = "sec$Role";
    name?: string | null;
    locName?: string | null;
    description?: string | null;
    type?: any | null;
    defaultRole?: boolean | null;
    permissions?: Permission[] | null;
}
----

* You can easily access entity name by static `NAME` property:
`Role.NAME`,
* The class contains all properties of the domain model entity including
ones from class hierarchy. Reference fields have corresponding types as
well so that you can work with them in a type-safe manner:

[source,typescript]
----
function changeRole(role: Role) {
  role.defaultRole = true;   // ok
  role.defaultRole = 'foo';  // compilation fails
}
----

[[synchronizing-project-model]]
=== Synchronizing Project Model

In order to regenerate project model to conform changes in the backend
you can use the following command:

[source,bash]
----
$ npm run `update-model`
----

[[security]]
=== Security

Since React client works via Generic REST API endpoints, the backend
(CUBA) application should have properly configured Security Roles and
Access groups. See the
https://doc.cuba-platform.com/restapi-7.2/#security[corresponding
chapter] in REST API documentation.

Package `cuba-rest-js` provide methods, which allows check for user
runtime security permissions for entity attributes and operations. *
`getAttributePermission` checks entity attribute permission and could
return `DENY` `VIEW` or `MODIFY` * `isOperationAllowed` checks entity
operation permission and returns `true` or `false`

[[building-the-client]]
=== Building the Client

`$ npm run build` command builds your app for production use. See
`build` folder.

See
https://facebook.github.io/create-react-app/docs/available-scripts[available
scripts] in Create React App documentation.

[[react-client-configuration]]
=== Configuration

By default, client deployed to Tomcat is built with production preset
and aimed to be served under `app-front` context. Use `PUBLIC_URL` env
variable to change this behavior (see `.env.production.local`).

The client served from development server has absolute URL of REST API
specified in `REACT_APP_CUBA_URL` (see `.env.development.local`).

See the
https://facebook.github.io/create-react-app/docs/advanced-configuration[list
of all available environment variables].

See `src/config.ts` for full list of common application settings used in
runtime.

[[react-native-client]]
== React Native Client

[[running-the-client-1]]
=== Running the Client

Install dependencies:

[source,bash]
----
npm install
----

The client uses https://expo.io/[Expo]. You may prefer to install Expo
CLI globally and use it from command line directly, or use it via npm
scripts, which doesn't require global installation.

[source,bash]
----
# with Expo CLI installed globally
expo [command] [options]

# without global installation
npm run expo -- [command] [options]
----

To install Expo CLI globally:

[source,bash]
----
npm install -g expo-cli
----

See https://expo.io/[Expo documentation] for details on available
commands and options. If you are running Expo via npm scripts, note that
there convenience scripts for the most frequently used commands:

[source,bash]
----
# start (restart) a local server for the app:
# with Expo CLI installed globally:
expo start
# via generic npm script:
npm run expo -- start
# via convenience npm script:
npm run start

# run the project in the browser:
# with Expo CLI installed globally:
expo start --web
# via generic npm script:
npm run expo -- start --web
# via convenience npm script:
npm run web

# run the project on an Android device or emulator:
# with Expo CLI installed globally:
expo start --android
# via generic npm script:
npm run expo -- start --android
# via convenience npm script:
npm run android

# run the project in an iOS simulator:
# with Expo CLI installed globally:
expo start --ios
# via generic npm script:
npm run expo -- start --ios
# via convenience npm script:
npm run ios

# eject:
# with Expo CLI installed globally:
expo eject
# via generic npm script:
npm run expo -- eject
# via convenience npm script:
npm run eject

# passing options to a convenience script:
npm run android -- --clear
# which would be the same as:
expo start --android --clear
----

_____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________
TIP: In order to run the app on an emulator/simulator you may need to change
`REACT_NATIVE_APP_CUBA_URL` in `.env` from `localhost` to your IP
address. You may need to clear the React Native Packager cache for the
change to take effect (e.g. `expo start --android --clear` or
`npm run android -- --clear`).
_____________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________________

[[technologies-1]]
=== Technologies

The client is based on the following frameworks and libraries:

* https://facebook.github.io/react-native/[React Native] - UI rendering;
* https://mobx.js.org/[MobX] - reactive state management;
* link:#cuba-react-core[CUBA React Core] - CUBA React core components and utilities;
* link:api-reference/cuba-rest-js/index.html[CUBA REST JS^] - interaction with СUBA
generic REST API;
* https://expo.io/[Expo] - development tools for React Native;

[[polymer-based-client-deprecated]]
== Polymer-based Client (Deprecated)

Documentation can be found
https://doc.cuba-platform.com/manual-latest/polymer_ui.html[here].

[[cuba-react-core]]
== CUBA React Core Components

[[cubaappprovider]]
=== CubaAppProvider

`CubaAppProvider` initializes main CUBA React Core components and
provides them to the client application. It receives an instance of REST
API service and an optional config object which has the following
interface:

[source,typescript]
----
import {PropertyType} from "@cuba-platform/rest";

export interface CubaAppConfig {
  dataTransferFormats?: Partial<Record<PropertyType, string>>;
  displayFormats?: Partial<Record<PropertyType, string>>;
}
----

`dataTransferFormats` can be used to override the default formats used
to (de)serialize the data transferred by REST API.

`displayFormats` can be used to override the formats used for data
presentation.

See
link:api-reference/cuba-rest-js/modules/\_model_.html#propertytype[PropertyType]
in CUBA REST JS API docs for the list of available property types.

____________________________________________________________________
NOTE: Only formats for temporal types can currently be overridden this way
____________________________________________________________________

[source,typescript]
----
<CubaAppProvider cubaREST={cubaREST}
                 config={{
                   dataTransferFormats: {
                     localDateTime: 'DD/MM/YYYY HH:mm:ss'
                   }
                 }}
>
   // App component tree
</CubaAppProvider>
----

[[mainstore]]
=== MainStore

`MainStore` contains common application data. It's being initialized
using `<CubaAppProvider>`.

You can inject it in any component using `@injectMainStore` decorator:

[source,typescript]
----
@injectMainStore
@observer
export class AppInfo extends React.Component<MainStoreInjected> {
  render() {
    if (!this.props.mainStore) {
      return null;
    }
    const {
      initialized,
      authenticated,
      userName,
      metadata,
      messages,
      enums
    } = this.props.mainStore;
    return (
      <ul>
        <li>App initialized: {initialized ? 'yes' : 'no'}</li>
        <li>User authenticated: {authenticated ? 'yes' : 'no'}</li>
        <li>User name: {userName}</li>
        <li>Metadata: {JSON.stringify(metadata)}</li>
        <li>Messages: {JSON.stringify(messages)}</li>
        <li>Enums: {JSON.stringify(enums)}</li>
      </ul>
    )
  }
}
----

[[datacollectionstore]]
=== DataCollectionStore

`DataCollectionStore` is a MobX based store for loading entity
collections. It can be created via `collection()` initializer function:

[source,typescript]
----
dataCollection = collection<Pet>(Pet.NAME, {
    view: 'pet-with-owner-and-type',
    sort: 'identificationNumber',
    filter: {conditions: [{property: 'name', operator: "contains", value: 'Ro'}]},
    limit: 10,
    offset: 0,
    loadImmediately: true, // true by default
  }
);
----

Typically it's being used to display list of entities. Since it's
reactive, any changes in `items` and `status` will trigger re-render of
`@observer` components:

[source,typescript]
----
@observer
class CarList extends React.Component {
  carsData = collection<Car>(Car.NAME, {view: 'car-view', sort: '-updateTs'});
  render() {
    if (this.carsData.status === "LOADING") return 'Loading...';
    return (
      <ul>
        {this.carsData.items.map(car =>
           <li>{car._instanceName}</li>
        )}
      </ul>
    )
  }
}
----

[[ClientSideDataCollectionStore]]
=== ClientSideDataCollectionStore

`ClientSideDataCollectionStore` is a variant of `DataCollectionStore` intended for situations when data shall be operated client-side. It is useful for example when handling link:https://www.cuba-platform.com/guides/data-modelling-composition[Composition relationship]. `ClientSideDataCollectionStore` can be created via `clientSideCollection()` initializer function.

[source,typescript]
----
dataCollection = clientSideCollection<Pet>(Pet.NAME, {
    allItems: entityInstancesArray,
    view: 'pet-with-owner-and-type',
    sort: 'identificationNumber',
    filter: {conditions: [{property: 'name', operator: "contains", value: 'Ro'}]},
    limit: 10,
    offset: 0,
    loadImmediately: true, // true by default
  }
);
----

`ClientSideDataCollectionStore` inteface extends `DataCollectionStore` adding the following members:

- `allItems` field - array of entity instances with default sort order and no filtering applied.
- `adjustItems` method - sets `items` based on `allItems` and other conditions. Currently it only performs the client-side sorting based on `sort` field, client-side filtering is not currently supported.

[[datainstancestore]]
=== DataInstanceStore

`DataInstanceStore` is used to work with a single instance of some
Entity. It can be created via `instance()` initializer function:

[source,typescript]
----
dataInstance = instance<Pet>(Pet.NAME, {view: 'pet-with-owner-and-type', loadImmediately: false});
----

Use `dataInstance.commit()` method to perform entity update:

[source,typescript]
----
dataInstance.item.name = 'New Name';
dataInstance.commit()
----

[[api-reference]]
=== API Reference

API reference for CUBA React Core components can be found
link:api-reference/cuba-react-core/index.html[here].

[[cuba-react-ui]]
== CUBA React UI Components

[[entityproperty]]
=== EntityProperty

`<EntityProperty>` component is aimed to display a value of some
Entity's property. It automatically applies formatting according to the
type of property and adds a corresponding label from global message pack
(defined on the backend)

[source,typescript]
----
<EntityProperty entityName={Pet.NAME}
                propertyName='birthDate'
                value={pet.birthDate}/>
----

[[formfield]]
=== FormField

`<FormField>` component automatically creates correct Form UI component
based on entity and property names:

[source,typescript]
----
<FormField entityName={Pet.NAME} propertyName='birthDate'/>
----

For the attributes with relationship it's possible to provide an
instance of DataCollectionStore via `optionsContainer` prop to render
options list

[source,typescript]
----
petTypesDc = collection<PetType>(PetType.NAME, {view: '_minimal', sort: 'name'});
...
<FormField entityName={Pet.NAME}
           propertyName='type'
           optionsContainer={this.petTypesDc}/>
----

[[entityeditor]]
=== EntityEditor

`EntityEditor` component is a form with dynamically rendered fields representing entity properties. It uses link:#formfield[FormField] to render correct input components (e.g. `Checkbox`, `Datepicker`, etc.) depending on entity property type. The list of displayed fields (that is, the list of properties to be edited) can be configured via `fields` prop.

[source,typescript]
----
<EntityEditor entityName={nestedEntityName}
              fields={this.fields}
              dataInstance={this.dataInstance}
              associationOptions={this.associationOptions}
              onSubmit={this.handleSubmit}
              onCancel={this.closeDrawer}
              submitButtonText='common.ok'
/>
----

API: {EntityEditorProps}.

[[nestedentityfield]]
=== NestedEntityField

`NestedEntityField` is a form field component that is used in the context of One-to-One Composition and represents the nested entity. It is a control that allows to create, edit or remove the nested entity. Create/edit will open an link:#entityeditor[EntityEditor] for the nested entity. link:#formfield[FormField] will automatically render a `NestedEntityField` for an One-to-One Composition entity property.

NOTE: Multiple levels of Composition (i.e. nested entities that themselves contain nested entities) are currently not supported.

API: {NestedEntityFieldProps}.

[[nestedentitiestablefield]]
=== NestedEntitiesTableField

`NestedEntitiesTableField` is a form field component that is used in the context of One-to-Many Composition and represents the nested entities. It will render a link:#datatable[DataTable] with buttons to create, edit or remove nested entities. Clicking create or edit button will open an link:#entityeditor[EntityEditor]. link:#formfield[FormField] will automatically render a `NestedEntitiesTableField` for an One-to-Many Composition entity property.

NOTE: Multiple levels of Composition (i.e. nested entities that themselves contain nested entities) are currently not supported.

API: {NestedEntitiesTableField}.

[[fileupload]]
=== FileUpload

`FileUpload` is a form field that allows uploading, removing and downloading files. For image files it allows to preview and download the file via link:#imagepreview[ImagePreview] component.  link:#formfield[FormField] will automatically render a `FileUpload` for a FileDescriptor entity property.

image:FileUploadAndImagePreviewDemo.apng[FileUpload and ImagePreview demo]

API: {FileUploadProps}.

[[imagepreview]]
=== ImagePreview

`ImagePreview` allows to preview or download an image. It works with an link:https://developer.mozilla.org/en-US/docs/Web/API/URL/createObjectURL[object URL].

API: {ImagePreviewProps}.

[[datatable]]
=== DataTable

`<DataTable>` is used to present data in tabular form.

image:react/data-table-demo.gif[Data table
showcase]

It uses Ant Design's https://ant.design/components/table/[Table] under
the hood and provides the following additional benefits:

* out-of-the-box integration with `DataCollectionStore`
* powerful filters +
* support for action buttons (e.g. for CRUD operations)

At the same time `<DataTable>` provides developer with a full access to
underlying `Table` via its `tableProps` and `columnDefinitions`
properties (see below).

Example of using `<DataTable>` API:

[source,typescript]
----
<DataTable dataCollection={this.dataCollection}
           columnDefinitions={[
             'item',
             'manufacturer',
             {
               field: 'price',
               columnProps: {
                 align: 'right'
               }
             }
           ]}
           onSelectedRowChange={this.onSelectedRowChange}
           buttons={buttons}
           tableProps={{
             bordered: true
           }}
/>
----

* `dataCollection` - instance of `DataCollectionStore`
* `columnDefinitions` - describes the columns to be displayed. See more
details below.
* `onSelectedRowChange` - callback that takes the id of selected row,
can be used together with `buttons` e.g. to facilitate CRUD operations
* `buttons` - array of React elements representing controls that will be
rendered above the table
* `tableProps` - can be used to override any of the underlying
https://ant.design/components/table/#Table[Table properties]

Deprecated props (use `columnDefinitions` instead):

* `fields` - array of entity property names
* `columnProps` - can be used to override underlying
https://ant.design/components/table/#Column[Column properties]. Applied
to every column.

____________________________________________________________________________________________________________________________________________________________________________________________
NOTE: `columnDefinitions` is more flexible and provides greater ability to
customize the columns. `columnDefinitions` will take precedence over
`fields` and `columnProps` if used simultaneously.
____________________________________________________________________________________________________________________________________________________________________________________________

[[columndefinitions]]
*columnDefinitions*

`columnDefinitions` describes the columns to be displayed. The columns
can represent entity properties or have arbitrary content (for example:
an action button column, a calculated field column).

There are 3 ways you can define a column:

*1.* Simply put an entity property name as a `string`. In this case
`DataTable` will render a column with default settings for that
property.

[source,typescript]
----
<DataTable
       dataCollection={this.dataCollection}
       columnDefinitions={[
         'manufacturer',
         // more columns
       ]}
/>
----

*2.* If you want to customize the default column, use a
`ColumnDefinition` object where `field` is an entity property name and
`columnProps` is an antd
https://ant.design/components/table/#Column[ColumnProps] object. The
properties you put in `columnProps` will override the default
properties.

[source,typescript]
----
<DataTable
       dataCollection={this.dataCollection}
       columnDefinitions={[
         {
           field: 'manufacturer', // property name
           columnProps: { // antd ColumnProps object
             align: 'right'
           }
         },
         // more columns
       ]}
/>
----

*3.* If you want a column not bound to an entity field, create it from
scratch using `columnProps` and do not specify a `field`.

[source,typescript]
----
<DataTable
       dataCollection={this.dataCollection}
       columnDefinitions={[
         {
           columnProps: { // antd ColumnProps object
             render: (text, record) => { /* render some custom content */ }
           }
         },
         // more columns
       ]}
/>
----

If you need even more control, you may want to start with a vanilla antd
https://ant.design/components/table/[Table] and take a look into
exported functions in `DataTableHelpers`. These functions are used to
create `DataTable` custom functionality such as custom filters. You
may also want to look into using `DataTableCustomFilter` directly. Note
that both these approaches may require deeper understanding of
`DataTable` internal workings.

[[api-reference-1]]
=== API Reference

API reference for CUBA React UI components can be found
link:api-reference/cuba-react-ui/index.html[here].

[[typescript-sdk]]
== TypeScript SDK

TypeScript SDK contains CUBA data model
(https://doc.cuba-platform.com/manual-latest/data_model.html[entities
and enums]), rest
https://doc.cuba-platform.com/restapi-7.2/#rest_api_v2_services_config[services]
and
https://doc.cuba-platform.com/restapi-7.2/#rest_api_v2_queries_config[queries]
as TypeScript classes.

The SDK is framework-agnostic, meaning that in addition to using it with
our React client, you can use it with any TypeScript-compatible
framework such as Angular of Vue.

It's possible to generate the following configurations of SDK depending
on your needs (see link:#generator-cli[usage instruction]):

* `gen-cuba-front sdk:model` - generates entities and enums
* `gen-cuba-front sdk:all` - generates all toolkit - entities, enums,
queries and services

SDK can be used for front-end clients and Node.js-based BFF (Backend for
Frontend) development.

[[entities]]
=== Entities

[[persistent-entities]]
*Persistent Entities*

Consider the `Role` entity class of CUBA Framework generated in
TypeScript:

`src/cuba/entities/base/sec$Role.ts`

[source,typescript]
----
export class Role extends StandardEntity {
    static NAME = "sec$Role";
    name?: string | null;
    locName?: string | null;
    description?: string | null;
    type?: any | null;
    defaultRole?: boolean | null;
    permissions?: Permission[] | null;
}
----

* you can easily access entity name by static `NAME` property:
`Role.NAME`,
* class contains all properties of domain model entity including from
class hierarchy, reference fields have corresponding types as well so
that you can work with them in a type-safe manner:

[source,typescript]
----
function changeRole(role: Role) {
  role.defaultRole = true;   // ok
  role.defaultRole = 'foo';  // compilation fails  
}
----

[[non-persistent-entities]]
*Non-persistent Entities*

CUBA Platform supports non-persistent entities in model. Entity class
should be annotated with
`com.haulmont.chile.core.annotations.MetaClass`, and extended from
`com.haulmont.cuba.core.entity.BaseUuidEntity`. Class properties
annotated with `com.haulmont.chile.core.annotations.MetaProperty` will
be included in generated model.

[[source]]
Source:

[source,java]
----
package com.company;

import com.haulmont.chile.core.annotations.MetaClass;
import com.haulmont.chile.core.annotations.MetaProperty;
import com.haulmont.cuba.core.entity.BaseUuidEntity;

@MetaClass(name = "SampleUserInfo")
public class SampleUserInfo extends BaseUuidEntity {

    @MetaProperty
    public String firstName;

    @MetaProperty
    public String lastName;
    
    }
----

[[generated]]
Generated:

[source,typescript]
----
export class SampleUserInfo {
    static NAME = "SampleUserInfo";
    firstName?: string | null;
    lastName?: string | null;
}
----

[[enums]]
=== Enums

CUBA REST API module uses enum’s constant name in client-server
communication. SDK contains generated string enums e.g.:

[source,typescript]
----
export enum CarType {
    SEDAN = "SEDAN",
    HATCHBACK = "HATCHBACK"
}
----

In order to get enum id and localized caption, you can query full
information about enums in runtime using `loadEnums` method of
cuba-rest-js:

[source,typescript]
----
import {EnumInfo, initializeApp} from "@cuba-platform/rest";

const cubaREST = initializeApp();
cubaREST.loadEnums()
    .then(((enums: EnumInfo[]) => {
        console.log('enums', enums)
    }));
----

Response example:

[source,json]
----
[{
    "name": "com.company.mpg.entity.CarType",
    "values": [
      {
        "name": "SEDAN",
        "id": "SEDAN",
        "caption": "Sedan"
      },
      {
        "name": "HATCHBACK",
        "id": "HATCHBACK",
        "caption": "Hatchback"
      }
    ]
  }]
----

[[rest-api]]
== REST API

Generated front-end clients use
https://doc.cuba-platform.com/restapi-7.2/[Generic REST API]. The
detailed documentation on the API endpoints is published
http://files.cuba-platform.com/swagger/7.2[here].

CUBA REST JS library is used to communicate
with Generic REST API. Documentation and API reference can be found
link:api-reference/cuba-rest-js/index.html[here^].
